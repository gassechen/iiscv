* PI-GPIO-DSL: Sistema Embebido con Auditoría IISCV

**Propósito:** Demostración práctica de un sistema embebido construido sobre IISCV.

---

**Casos de Uso:**

1. **Desarrollo Colaborativo:** Múltiples desarrolladores creando DSL y aplicaciones
2. **Sistema Embebido Remoto:** Máquina autónoma (Luna, Marte, Andes) sin dependencia de Git
3. **Producción Industrial:** PLC en Raspberry Pi con control auditado de pines GPIO

---

**Arquitectura de Paquetes (3 Niveles de Confianza):**

```
┌─────────────────────────────────────────────────────────┐
│ NIVEL 3: gpio-app (Aplicación)              │
│ - Lógica de iluminación y ventilación          │
│ - Reglas: Botón de emergencia, modo manual    │
│ - Auditoría: make-atomic-commit por operación   │
└─────────────────────────────────────────────────────────┘
                      ↓ usa
┌─────────────────────────────────────────────────────────┐
│ NIVEL 2: gpio-dsl (DSL de Dominio)          │
│ - Macros: def-pin, def-led-control, def-relay  │
│ - Reglas LISA: Reservados, conflictos, delay   │
│ - Auditoría: make-atomic-commit + LISA GPIO     │
└─────────────────────────────────────────────────────────┘
                      ↓ usa
┌─────────────────────────────────────────────────────────┐
│ NIVEL 1: iiscv (Framework)                  │
│ - Grafo de historia atómico + humano            │
│ - Reglas LISA generales (ISO/IEC 25010)      │
│ - Funciones: rebuild-*, save-production-image     │
└─────────────────────────────────────────────────────────┘
```

---

**Instalación y Uso:**

1. **Cargar el sistema:**
   #+BEGIN_SRC lisp
   (ql:quickload "pi-gpio-dsl")
   (in-package #:gpio-app)
   #+END_SRC

2. **Iniciar el sistema:**
   #+BEGIN_SRC lisp
   (start-lighting-system)
   ;; Output:
   ;; === INICIANDO SISTEMA DE ILUMINACIÓN ===
   ;; Iniciando sistema GPIO con IISCV...
   ;; Sistema GPIO listo.
   #+END_SRC

3. **Operar en modo manual:**
   #+BEGIN_SRC lisp
   (manual-override)
   ;; === ACTIVANDO MODO MANUAL ===
   #+END_SRC

4. **Parada de emergencia:**
   #+BEGIN_SRC lisp
   (emergency-stop)
   ;; === PARADA DE EMERGENCIA ACTIVADA ===
   #+END_SRC

---

**Auditoría en Cascada:**

Cuando defines un pin con el DSL:

#+BEGIN_SRC lisp
(def-relay main-light
  pin:18
  :activation-delay 100)
#+END_SRC

**Lo que sucede:**

1. **Nivel GPIO-DSL:** Verifica reglas específicas (delay de relé)
2. **Nivel IISCV:** Genera atomic commit para el historial
3. **Grafo Único:** Conviven commits del DSL y de la aplicación

---

**Reglas de Auditoría GPIO-DSL:**

| Regla | ID | Severidad | Descripción |
|--------|-----|-----------|-------------|
| Pines reservados | GPIO-1 | ERROR | Bloque uso de pines 2 y 3 (I2C) |
| Conflicto de dirección | GPIO-2 | ERROR | Detecta configuraciones contradictorias del mismo pin |
| Activación frecuente crítica | GPIO-3 | WARNING | Alerta de conmutación rápida en salidas críticas |
| Seguridad de relé | GPIO-4 | ERROR | Previene cambios sin delay mínimo de seguridad |

---

**Forense y Debugging:**

*Ver historial de commits humanos:*
#+BEGIN_SRC lisp
(iiscv:show-project-milestones)
# - Milestone: Initial hardware configuration
# - Milestone: Safety parameters configured
# - Milestone: System control logic implemented
# - Milestone: Lighting System ready for production
#+END_SRC

*Ver configuración de un pin específico:*
#+BEGIN_SRC lisp
(gpio-dsl:get-last-pin-configuration 'main-light)
;; Retorna la última definición del relé
#+END_SRC

*Reconstruir desde historial:*
#+BEGIN_SRC lisp
(iiscv:rebuild-image-from-human-history)
;; Reconstruye el sistema desde commits curados
#+END_SRC

---

**Generación de Imagen de Producción:**

#+BEGIN_SRC lisp
;; 1. Verificar que no hay commits atómicos huérfanos
(iiscv:has-pending-changes-p)  ; debe ser NIL

;; 2. Generar imagen limpia
(iiscv:save-production-image "/opt/pi-gpio/prod.core")
#+END_SRC

---

**Acceso a la Máquina (Login Shell):**

```bash
# Configurar usuario con shell IISCV
chsh -s /opt/pi-gpio/dev.core operator

# Al entrar por SSH, aparece directamente:
IISCV-R> (start-lighting-system)
```

---

**Archivos del Proyecto:**

| Archivo | Propósito |
|---------|-----------|
| pi-gpio-dsl.asd | Definición del sistema ASDF |
| packages/iiscv.lisp | Referencia al framework IISCV |
| packages/bcm2835-ffi.lisp | FFI para control de GPIO BCM2835 |
| packages/gpio-dsl.lisp | DSL de alto nivel con auditoría LISA |
| packages/gpio-app.lisp | Aplicación de ejemplo (iluminación) |

---

**Exportación de Código Limpio:**

#+BEGIN_SRC lisp
(iiscv:dump-source-code-by-commit-type "/opt/pi-gpio/output/")
# Genera:
# - functions.lisp
# - variables.lisp
# - types.lisp
# - slot-changes.lisp
# - dependencies.lisp
#+END_SRC

---

**Conclusión:**

Este proyecto demuestra cómo **IISCV** permite:
- ✅ Crear DSL auditables para dominios específicos
- ✅ Aplicar reglas de seguridad industrial en tiempo real
- ✅ Mantener forense completo del desarrollo
- ✅ Generar imágenes de producción autónomas
- ✅ Operar sin dependencia de herramientas externas

**La máquina es su propia fuente de verdad.**
